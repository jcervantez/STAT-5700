---
title: "Modern Data Mining, HW 1"
author:
- Rob Kuan
- Bethany Hsaio
- Jose Cervantez
date: 'Due: 11:59PM,  Feb 4th, 2024'
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '4'
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
header-includes:
    - \usepackage{xcolor}
---


```{r setup, include=FALSE}
rm(list=ls()) 
knitr::opts_chunk$set(echo = FALSE, results = "hide", fig.width=8, fig.height=4)
options(scipen = 0, digits = 3)  # controls base R output
# check if you have ISLR package, if not, install it
if(!require('pacman')) {install.packages('pacman')}
pacman::p_load(ISLR, readxl, tidyverse, magrittr, dplyr, ggplot2)
```


\pagebreak

# Overview

This is a fast-paced course that covers a lot of material. There will be a large amount of references. You may need to do your own research to fill in the gaps in between lectures and homework/projects. It is impossible to learn data science without getting your hands dirty. Please budget your time evenly. Last-minute work ethic will not work for this course. 

Homework in this course is different from your usual homework assignment as a typical student. Most of the time, they are built over real case studies.  While you will be applying methods covered in lectures, you will also find that extra teaching materials appear here.  The focus will be always on the goals of the study, the usefulness of the data gathered, and the limitations in any conclusions you may draw. Always try to challenge your data analysis in a critical way. Frequently, there are no unique solutions. 

Case studies in each homework can be listed as your data science projects (e.g. on your CV) where you see fit. 



## Objectives 

- Get familiar with `R-studio` and `RMarkdown`
- Hands-on R 
- Learn data science essentials 
    - gather data
    - clean data
    - summarize data 
    - display data
    - conclusion
- Packages
    - `dplyr`
    - `ggplot`

##  Instructions

- **Homework assignments can be done in a group consisting of up to three members**. Please find your group members as soon as possible and register your group on our Canvas site.

- **All work submitted should be completed in the R Markdown format.** You can find a cheat sheet for R Markdown [here](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf) For those who have never used it before, we urge you to start this homework as soon as possible. 

- **Submit the following files, one submission for each group:**  (1) Rmd file, (2) a compiled  HTML or pdf version, and (3) all necessary data files if different from our source data. You may directly edit this .rmd file to add your answers. If you intend to work on the problems separately within your group, compile your answers into one Rmd file before submitting. We encourage that you at least attempt each problem by yourself before working with your teammates. Additionally, ensure that you can 'knit' or compile your Rmd file. It is also likely that you need to configure Rstudio to properly convert files to PDF. [**These instructions**](http://kbroman.org/knitr_knutshell/pages/latex.html#converting-knitrlatex-to-pdf) might be helpful.

- In general, be as concise as possible while giving a fully complete answer to each question. All necessary datasets are available in this homework folder on Canvas. Make sure to document your code with comments (written on separate lines in a code chunk using a hashtag `#` before the comment) so the teaching fellows can follow along. R Markdown is particularly useful because it follows a 'stream of consciousness' approach: as you write code in a code chunk, make sure to explain what you are doing outside of the chunk. 

- A few good or solicited submissions will be used as sample solutions. When those are released, make sure to compare your answers and understand the solutions.


## Review materials

- Study Basic R Tutorial
- Study Advanced R Tutorial (to include `dplyr` and `ggplot`)
- Study lecture 1: Data Acquisition and EDA


# Case study 1: Audience Size

How successful is the Wharton Talk Show [Business Radio Powered by the Wharton School](https://businessradio.wharton.upenn.edu/)  


**Background:** Have you ever listened to [SiriusXM](https://www.siriusxm.com/)? Do you know there is a **Talk Show** run by Wharton professors in Sirius Radio?  Wharton launched a talk show called [Business Radio Powered by the Wharton School](https://businessradio.wharton.upenn.edu/) through the Sirius Radio station in January of 2014. Within a short period of time the general reaction seemed to be overwhelmingly positive. To find out the audience size for the show, we designed a survey and collected a data set via MTURK in May of 2014. Our goal was to **estimate the audience size**. There were 51.6 million Sirius Radio listeners then. One approach is to estimate the proportion of the Wharton listeners to that of the Sirius listeners, $p$, so that we will come up with an audience size estimate of approximately 51.6 million times $p$. 

To do so, we launched a survey via Amazon Mechanical Turk ([MTurk](https://www.mturk.com/)) on May 24, 2014 at an offered price of \$0.10 for each answered survey.  We set it to be run for 6 days with a target maximum sample size of 2000 as our goal. Most of the observations came in within the first two days. The main questions of interest are "Have you ever listened to Sirius Radio" and "Have you ever listened to Sirius Business Radio by Wharton?". A few demographic features used as control variables were also collected; these include Gender, Age and Household Income.  

We requested that only people in United States answer the questions. Each person can only fill in the questionnaire once to avoid duplicates. Aside from these restrictions, we opened the survey to everyone in MTurk with a hope that the sample would be more randomly chosen. 

The raw data is stored as `Survey_results_final.csv` on Canvas.

## Data preparation

1. We need to clean and select only the variables of interest. 

Select only the variables Age, Gender, Education Level, Household Income in 2013, Sirius Listener?, Wharton Listener? and Time used to finish the survey.

Change the variable names to be "age", "gender", "education", "income", "sirius", "wharton", "worktime".

\textcolor{red}{\textbf{Answer:}}

```{r echo=TRUE, results='markup'}
d0 <- read.csv('data/Survey_results_final.csv', header = T) |> 
  select(Answer.Age, Answer.Gender, Answer.Education, Answer.HouseHoldIncome, Answer.Sirius.Radio, Answer.Wharton.Radio, WorkTimeInSeconds) |> 
  rename(age = Answer.Age,
         gender = Answer.Gender,
         education = Answer.Education,
         income = Answer.HouseHoldIncome,
         sirius = Answer.Sirius.Radio,
         wharton = Answer.Wharton.Radio,
         worktime = WorkTimeInSeconds)

names(d0) 

```

2. Handle missing/wrongly filled values of the selected variables

As in real world data with user input, the data is incomplete, with missing values, and has incorrect responses. There is no general rule for dealing with these problems beyond “use common sense.” In whatever case, explain what the problems were and how you addressed them. Be sure to explain your rationale for your chosen methods of handling issues with the data. Do not use Excel for this, however tempting it might be.

\textcolor{red}{\textbf{Code Cleaning:}}

```{r, results='markup', echo=T, warning=F}
## assign NA for empty strings
d0 <- d0 %>%
  mutate(across(where(is.character), ~na_if(., "")))


## age
#table(d0$age)

d0 <- d0 |> 
  mutate(age = case_when(
    age == "27`" ~ "27",                   # Change '27`' to '27'
    age == "Eighteen (18)" ~ "18",         # Change 'Eighteen (18)' to '18'
    TRUE ~ age                             # Set all other values to age
  )) |> 
  mutate(age = as.numeric(age),                   # Convert age to numeric
  age = case_when(
    age > 100 | age < 18 ~ NA_real_,                  # Replace age > 100 with NA
    TRUE ~ age                             # Keep all other ages as they are
  ))


## gender
# table(d0$gender) # good


## education
# table(d0$education)
d0 <- d0 |> 
  mutate(education = case_when(
    education %in% c("Other", "select one") ~ NA_character_,
    TRUE ~ education
  ))

## income
# table(d0$income) # good


## sirius
# table(d0$sirius) # good

## wharton
# table(d0$wharton) # good

## worktime
# table(d0$worktime) # good


```

Tip: Reflect on the reasons for which data could be wrong or missing. How would you address each case? For this homework, if you are trying to predict missing values with regression, you are definitely overthinking. Keep it simple.

\textcolor{red}{\textbf{Reasoning:}}

\begin{itemize}
  \item For each variable in our dataset, I executed a `table` command to visually expect the frequencies of the data. I also used personal judgment to assess whether the item was either missing, entered incorrectly, or unable to tell the difference. In the cases that I was able to quickly identify that the value was entered in an incorrect format, I adjusted the format correctly. For example, changing `Eighteen (18)` to `18.` For items that were entered incorrectly but I couldn't determine a reasonable alternative or for missing data, I assumed NA for those values.
\end{itemize}


3. Brief summary 

Write a brief report to summarize all the variables collected. Include both summary statistics (including sample size) and graphical displays such as histograms or bar charts where appropriate. Comment on what you have found from this sample. (For example - it's very interesting to think about why would one work for a job that pays only 10cents/each survey? Who are those survey workers? The answer may be interesting even if it may not directly relate to our goal.)

\textcolor{red}{\textbf{Code for Summary Stats:}}

```{r echo=TRUE}
summarize_data <- function(df) {
  for (column_name in names(df)) {
    data <- df[[column_name]]

    cat("\n\nSummary for column:", column_name, "\n")
    
    if (is.numeric(data)) {
      # Numeric summary
      summary_stats <- summary(data)
      print(summary_stats)
      
      # Histogram using ggplot2
      p <- ggplot(df, aes(x = .data[[column_name]])) +
        geom_histogram(binwidth = 1, fill = "blue", color = "black") +
        labs(title = paste("Histogram of", column_name), x = column_name, y = "Count")+
        theme(legend.position = "none")
      
      # Handling NA values explicitly
      if (any(is.na(data))) {
        p <- p + geom_histogram(data = df[!is.na(df[[column_name]]), ], aes(x = .data[[column_name]]))
      }
    
    } else if (is.factor(data) || is.character(data)) {
      # Categorical summary
      cat_table <- data.frame(table(data))
      total <- sum(cat_table$Freq)
      cat_table$Perc <- (cat_table$Freq / total) * 100
      # Find the maximum frequency to adjust ylim
      max_freq <- max(cat_table$Freq)
  
  # Bar Plot using ggplot2
    p <- ggplot(cat_table, aes(x = data, y = Freq, fill = data)) +
      geom_bar(stat = "identity") +
      geom_text(aes(label = sprintf("%.1f%%", Perc)), vjust = -0.5, size = 7, position = position_stack(vjust = 1)) +
      labs(title = paste("Bar Plot of", column_name), x = column_name, y = "Frequency") +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      ylim(0, max_freq * 1.2)+  # Increase ylim by 20%
      theme(legend.position = "none")



    
    }
    print(p)
  }
}
# Define the mapping from old to new names so it can fit in the graph
education_mapping <- c(
  "Bachelor’s degree or other 4-year degree" = "Bachelors",
  "Some college, no diploma; or Associate’s degree" = "Some College",
  "Graduate or professional degree" = "Graduate",
  "High school graduate (or equivalent)" = "High school",
  "Less than 12 years; no high school diploma" = "Less than High School"
)

# Replace the values in the dataframe
d0$education <- factor(education_mapping[d0$education])

summarize_data(d0)
```

\textcolor{red}{\textbf{Summary Data Report:}}
\begin{itemize}
  \item \textbf{Sample Size:} The survey collected responses from 1,764 participants.
  \item \textbf{Age Distribution:} The ages of participants range from 18 to 76 years, with a mean age of approximately 30.4 years. 
  \item \textbf{Work Time:} The time taken to complete the survey ranged from 4 to 108 seconds, with an average time of approximately 22.5 seconds. This quick completion time reflects the survey's simplicity or possibly the respondents' familiarity with such tasks.
  \item \textbf{Gender Distribution:} The distribution between genders was relatively balanced, with men representing approximately 57.6\% and women 42.4\% of the sample.
  \item \textbf{Sirius Radio Listenership:} A significant majority, about 77.3\%, reported having listened to Sirius Radio, indicating a broad engagement among the survey participants. 
  \item \textbf{Wharton Radio Listenership:} Only a small fraction, about 4\%, of respondents reported having listened to the Wharton Radio on SiriusXM, suggesting that while SiriusXM's reach is extensive, the specific audience for the Wharton show is relatively small.
\end{itemize}



## Sample properties

The population from which the sample is drawn determines where the results of our analysis can be applied or generalized. We include some basic demographic information for the purpose of identifying sample bias, if any exists. Combine our data and the general population distribution in age, gender and income to try to characterize our sample on hand.

1. Does this sample appear to be a random sample from the general population of the USA? Why it is crucial to have randomness here? 

\begin{itemize}
  \item The sample does not appear to be a random. Our current data says that 75\% of the population is within 23-34 years of age. However, according to the Census, only 20\% of the population are between the ages of 23-34.\footnote{https://www.census.gov/data/tables/2022/demo/age-and-sex/2022-age-sex-composition.html} Furthermore, the educational attainment is slightly skewed towards some college and bachelor's degree in our sample. According to the Census, it shows that approximately 15\% of the population had completed some college, however, our sample shows that 42.7\% of the sample hand completed some college. Additionally, according to the Census, it shows that the 23\% of the population had completed a bachelor's degree, whereas our sample suggests that approximately 35.2\% had completed it.\footnote{https://www.census.gov/newsroom/press-releases/2023/educational-attainment-data.html}
\end{itemize}
  

2. Does this sample appear to be a random sample from the MTURK population?

\begin{itemize}
  \item The sample does appear to be a random sample from the MTurk population. Namely, the sample skews younger than the general US population, which is consistent with both the MTurk population and our sample.\footnote{https://www.cloudresearch.com/resources/blog/who-uses-amazon-mturk-2020-demographics/} Additionally, our sample is more concentrated around the middle income categories (e.g., 20k - 75k), which is consistent with the MTurk sample, but lower income on average than the US population.\footnote{https://www.cloudresearch.com/resources/blog/who-uses-amazon-mturk-2020-demographics/}
\end{itemize}

## Final estimate

Give a final estimate of the Wharton audience size by May of 2014. Assume that the sample is a random sample of the MTURK population, and that the proportion of Wharton listeners vs. Sirius listeners in the general population is the same as that in the MTURK population. Write a brief executive summary to summarize your findings and how you came to that conclusion.

\textbf{Goal of the Study:}

The primary goal of this study was to estimate the audience size for the Wharton School's talk show on Sirius Radio, "Business Radio Powered by the Wharton School," as of May 2014. This estimation aimed to understand the show's reach among Sirius Radio listeners, leveraging a survey conducted via Amazon Mechanical Turk (MTurk).

\textbf{Method Used:}

Data were gathered through a survey launched on MTurk on May 24, 2014, targeting a maximum sample size of 2000 respondents over six days. The survey inquired about listenership to Sirius Radio and the Wharton Business Radio specifically, alongside demographic variables such as gender, age, and household income. The estimation method involved calculating the proportion of Wharton listeners to Sirius listeners within the MTurk sample and applying this proportion to the known total of 51.6 million Sirius Radio listeners to estimate the Wharton show's audience size.

\textbf{Findings:}

After cleaning the dataset, it revealed that out of 1358 respondents who have listened to Sirius Radio, 68 reported listening to the Wharton Business Radio. This results in a proportion of approximately 4.98% of Sirius listeners also tuning into the Wharton show. By applying this proportion to the total Sirius audience, we estimate the Wharton Business Radio's audience size to be around 2,570,549 listeners as of May 2014.

```{r, results='asis'}
options(scipen=999)
# Step 1: Filter respondents who have listened to Sirius Radio
sirius_listeners_df <- d0[d0$sirius == 'Yes', ]

# Step 2: Count the number of respondents who have also listened to the Wharton Business Radio
wharton_listeners_count <- sum(sirius_listeners_df$wharton == 'Yes', na.rm = T)

# Step 3: Calculate the proportion of Wharton listeners among Sirius listeners
proportion_wharton <- wharton_listeners_count / nrow(sirius_listeners_df)

# Step 4: Total Sirius Radio listeners as of May 2014
total_sirius_listeners <- 51600000

# Estimate Wharton Business Radio's audience size
estimated_wharton_audience <- total_sirius_listeners * proportion_wharton

# Create a summary table
summary_table <- data.frame(
  Total_Sirius_Listeners = nrow(sirius_listeners_df),
  Wharton_Listeners_Count = wharton_listeners_count,
  Proportion_Wharton = proportion_wharton,
  Estimated_Wharton_Audience = round(estimated_wharton_audience)
) 

# Transpose the summary table and convert it to a data frame
summary_table <- t(summary_table) %>% as.data.frame()

# Add row names as a new column for Attribute
summary_table <- cbind(Attribute = rownames(summary_table), summary_table)

# Rename the second column to Value
colnames(summary_table)[2] <- "Value"

# Ensure Value is of type numeric for formatting
summary_table$Value <- as.numeric(summary_table$Value)

# Now, your loop should look like this:
for (i in 1:nrow(summary_table)) {
  # Replace underscores with spaces for LaTeX output
  attribute_name_latex_safe = gsub("_", " ", summary_table$Attribute[i])
  
  if (summary_table$Attribute[i] == "Estimated_Wharton_Audience") {
    cat(paste0("\\textcolor{red}{", attribute_name_latex_safe, ": ", format(summary_table$Value[i], big.mark = ","), "}\\newline\n"))
  } else {
    cat(paste0(attribute_name_latex_safe, ": ", format(summary_table$Value[i], big.mark = ","), "\\newline\n"))
  }
}


```


## New task

Now suppose you are asked to design a study to estimate the audience size of Wharton Business Radio Show as of today: You are given a budget of $1000. You need to present your findings in two months. 

Write a proposal for this study which includes:

1. Method proposed to estimate the audience size.
2. What data should be collected and where it should be sourced from. (Can we use ChatGPT to get us a rough estimate?)

Please fill in the google form to list your platform where surveys will be launched and collected [HERE](https://forms.gle/8SmjFQ1tpqr6c4sa8) 


A good proposal will give an accurate estimation with the least amount of money used. 





# Case study 2: Women in Science


Are women underrepresented in science in general? How does gender relate to the type of educational degree pursued? Does the number of higher degrees increase over the years? In an attempt to answer these questions, we assembled a data set (`WomenData_06_16.xlsx`) from [NSF](https://ncses.nsf.gov/pubs/nsf19304/digest/field-of-degree-women) about various degrees granted in the U.S. from 2006 to 2016. It contains the following variables: Field (Non-science-engineering (`Non-S&E`) and sciences (`Computer sciences`, `Mathematics and statistics`, etc.)), Degree (`BS`, `MS`, `PhD`), Sex (`M`, `F`), Number of degrees granted, and Year.

Our goal is to answer the above questions only through EDA (Exploratory Data Analyses) without formal testing. We have provided sample R-codes in the appendix to help you if needed. 


## Data preparation  

1. Understand and clean the data

Notice the data came in as an Excel file. We need to use the package `readxl` and the function `read_excel()` to read the data `WomenData_06_16.xlsx` into R. 


a). Read the data into R.
```{r}
# read in data
wsci <- read_excel("data/WomenData_06_16.xlsx")
head(wsci)
```

b). Clean the names of each variables. (Change variable names to  `Field`,`Degree`, `Sex`, `Year` and `Number` )

I inspected the variable names by looking at head(wsci). Only "Field and sex" and "Degrees Awarded" are not the correct names, so I rename those.

```{r}
# Rename the variables of "Field and Sex" and "Degrees Awarded" (all other variable names are good already)
head(wsci)
wsci %<>% 
  rename(Field = 'Field and sex',
         Number = 'Degrees Awarded')
```

c). Set the variable natures properly. 
I inspected the variable natures using str(wsci). Field, Degree, and Sex are strings, which is appropriate for their data. Year and Number are numeric, which are also appropriate.
```{r}
# Examine variable natures - everything looks appropriate
str(wsci)
```

d). Any missing values?
I checked for missing values by inspecting the summary of wsci, the table of values for each variable, and calculating the sum of all NA values. This reveals that there are no missing values. All columns have the same length, and there are no null values in any of the columns.
```{r}
#summary of everything
summary(wsci)

# Look at values for each variable
table(wsci$Field)
table(wsci$Degree)
table(wsci$Sex)
table(wsci$Year)
table(wsci$Number)

# Sum of all null variables - sum is 0 indicating there are no null values
sum(is.na(wsci))
```

2. Write a summary describing the data set provided here. 

a). How many fields are there in this data?
I found the number of fields by looking at the length of the list of unique values in Field. There are 10 unique fields.
```{r}
# Get unique values in Field
length(unique(wsci$Field))
```

b). What are the degree types? 
I got the degree types by looking at the unique values in Degree. They are BS, MS, PhD.
```{r}
# Get unique values in Degree
unique(wsci$Degree)
```

c). How many year's statistics are being reported here? 
I found this by looking at the length of the list of unique values in Year. There are 11 years of statistics in this dataset.
```{r}
# Get number of unique values in Year
length(unique(wsci$Year))
```


## BS degrees in 2015

Is there evidence that more males are in science-related fields vs `Non-S&E`? Provide summary statistics and a plot which shows the number of people by gender and by field. Write a brief summary to describe your findings.

To examine this, I filtered the data to include just data on BS degrees from 2015. Then, I looked at summary statistics of the number of degrees earned by men and women and plotted the number of S&E and non-S&E degrees earned by men and women.

There is not evidence that there are more males in science-related fields. In 2015, 327122 males earned S&E degrees and 493304 males earned non-S&E degrees, indicating that there are fewer males in science-related fields. Additionally, there is not evidence that there are more men than women obtaining S&E BS degrees. In 2015, 322935 women and 327122 earned S&E degrees, showing that roughly the same number of females as males obtained S&E degrees. 
```{r}
# Filter data to just be BS degrees earned in 2015
bs_2015 = wsci %>% filter(Year == 2015, Degree == "BS")

# Calculate statistics by non-S&E and S&E degrees
bs_2015_stats = bs_2015 %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex) %>%
  summarise(SE_number = sum(Number))
```
```{r, echo=FALSE}
knitr::kable(bs_2015_stats, caption = "Summary Statistics of Degrees Earned for Non-S&E vs S&E")
```


```{r}
# Calculate statistics by non-S&E vs S&E degrees and gender
bs_2015 %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = SE, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.y = element_text(angle = 60)) +
  ggtitle("Degrees granted by S&E vs non-S&E by gender")
```

## EDA bringing type of degree, field and gender in 2015

Describe the number of people by type of degree, field, and gender. Do you see any evidence of gender effects over different types of degrees? Again, provide graphs to summarize your findings.

When we include the Degree in our analyses, we see that overall, more women than men pursue degrees at the BS, MS, and PhD levels. When we consider S&E vs non-S&E fields, more men than women earn S&E degrees at the MS and PhD levels. Once we include all fields, we notice larger gender effects for non-S&E, psychology, biological sciences, and engineering fields across all degrees. For non-S&E, psychology, and biological sciences degrees, more women than men pursue these. On the other hand, for engineering degrees, more men than women pursue these. 

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# filter data to 2015
data_2015 = wsci %>% filter(Year == 2015)

# Get number of degrees earned by degree type, field, and gender
data_2015 %>%  
  group_by(Sex, Degree, Field) %>%
  summarise(Number = sum(Number))

# Get number of degrees earned by sex, degree, and S&E vs non S&E. Plot in bar chart so as to compare between males and females.
data_2015 %>%  
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Degree) %>%
  summarise(Number = sum(Number)) %>%
  ggplot(aes(x = SE, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(SE~Degree, scales = "free_y") +
  ggtitle("Degrees granted by sex, degree and SE")

# Include fields, degree, and gender
data_2015 %>%
  ggplot(aes(x = Field, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Degree~., scales = "free_y") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  ggtitle("Degrees granted across fields by degree and gender in 2015") 
```

## EDA bring all variables 

In this last portion of the EDA, we ask you to provide evidence numerically and graphically: Do the number of  degrees change by gender, field, and time? 

When we display the proportion of females in each degree over time, we see that the relative proportion of females remains fairly stable over time for most fields in all degrees. We can also examine the number of degrees earned by gender. When we only consider females, we see overall increases in the number of degrees earned across all fields and degree types. We see the same trend when we only consider males. Comparing females with males, more women than men pursue degrees across all degree types. For both men and women, non S&E degrees are the most pursued degree. Excluding these from our analysis, we see that consistently more men than women pursue engineering degrees across all degree types.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# Plot how proportion of females in each degree type and field changes over time.
wsci %>%
  group_by(Field, Sex, Year, Degree) %>%
  summarise(Number = sum(Number)) %>% # number of degrees earned by field, sex, year, and degree
  group_by(Field, Year, Degree) %>% 
  mutate(ratio = Number / sum(Number)) %>% # get ratio of women to men for each field, year, and egree
  filter(Sex == "Female") %>% # filter to just women
  ggplot(aes(x = Year, y = ratio, color = Field)) +
  geom_point() + geom_line() +
  facet_grid(~Degree)+
  ggtitle("Female proportion in fields across year and degree") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

# Plot how number of degrees earned by women in each field changes over time
wsci %>%
  filter(Sex == "Female") %>% # filter to just women
  group_by(Field, Year, Degree) %>%
  summarise(Number = sum(Number)) %>% # number of degrees earned by field, year, degree
  ggplot(aes(x = Year, y = Number, color = Field)) +
  geom_point() + geom_line() +
  facet_wrap(~Degree, scales="free_y")+
  ggtitle("Number of degrees earned by females across fields and year")+
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

# same as above but for men
wsci %>%
  filter(Sex == "Male") %>%
  group_by(Field, Year, Degree) %>%
  summarise(Number = sum(Number)) %>%
  ggplot(aes(x = Year, y = Number, color = Field)) +
  geom_point() + geom_line() +
  facet_wrap(~Degree, scales="free_y")+
  ggtitle("Number of degrees earned by males across fields and year")+
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

wsci %>%
  group_by(Sex, Field, Year, Degree) %>%
  summarise(Number = sum(Number)) %>% # number of degrees earned by sex, field, year, degree
  ggplot(aes(x = Year, y = Number, color = Field)) +
  geom_point() + geom_line() +
  facet_wrap(Sex~Degree, scales="free_y")+
  ggtitle("Number of degrees earned across fields, sex, and year")+
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

# Plot how number of S&E degrees across all degree types changes over time for both men and women. Stack them to make them easier to compare.
wsci %>%
  filter(Field != "Non-S&E") %>% # filter to only be S&E degrees
  group_by(Sex, Field, Year, Degree) %>%
  summarise(Number = sum(Number)) %>% # number of degrees earned by sex, field, year, degree
  ggplot(aes(x = Year, y = Number, color = Field)) +
  geom_point() + geom_line() +
  facet_wrap(Sex~Degree, scales="free_y")+
  ggtitle("Number of S&E degrees earned across fields, sex, and year")+
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 
```

## Women in Data Science

Finally, is there evidence showing that women are underrepresented in data science? Data science is an interdisciplinary field of computer science, math, and statistics. You may include year and/or degree.

There is evidence that women are underrepresented in data science. For all 3 degrees, less than 1/2 of data science degree pursuers are women. The ratio of women seeking data science BS and PhD degrees has decreased over time, showing that the gender gap has widened. Interestingly, the ratio of women seeking data science MS has increased over time. However, the ratio of female MS degree holders remains around 1/3. When we look at the number of women and men pursuing data science degrees, we see that there has been an increase for both men and women over time. However, for BS, MS, and PhD degrees, the rate of increase for men is higher than that for women. All of this provides supporting evidence that women are underrepresented in data science. With the rate of increase for men outpacing that of women, this suggests that we may not be able to expect the gender gap in data science to decrease in the near future.

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
# Plot how proportion of women in data science fields in all degree types changes over time
wsci %>%
  filter(Field %in% c("Computer sciences", "Mathematics and statistics")) %>% # filter to data science degrees
  group_by(Sex, Year, Degree) %>%
  summarise(Number = sum(Number)) %>% # number of degrees earned by sex, year, degree type
  group_by(Year, Degree) %>%
  mutate(ratio = Number / sum(Number)) %>% # ratio of women to men for each year and degree type
  filter(Sex == "Female") %>%
  ggplot(aes(x = Year, y = ratio, color=Degree)) +
  geom_point() + geom_line() +
  ggtitle("Female proportion in data science across year by degree")+
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

# Plot how number of data science degrees earned over all degree types changes over time for both men and women
wsci %>%
  filter(Field %in% c("Computer sciences", "Mathematics and statistics")) %>% # filter to data science degrees
  group_by(Sex, Year, Degree) %>%
  summarise(Number = sum(Number)) %>% # number of degrees earned by sex, year, degree type 
  group_by(Year, Degree) %>%
  ggplot(aes(x = Year, y = Number, color=Sex)) + # color plot by Sex
  geom_point() + geom_line() +
  facet_wrap(~Degree, scales="free_y")+
  ggtitle("Number of data science degrees across year and degree")
```

## Final brief report

Summarize your findings focusing on answering the questions regarding if we see consistent patterns that more males pursue science-related fields. Any concerns with the data set? How could we improve on the study?

In summary, our data analysis shows that in general, more males pursue science-related fields. That is, across time and all three degree types, more men than women pursue science-related degrees. This is especially true for the fields related to engineering, data science, and "harder" sciences. However, when we consider "softer" sciences, such as psychology and social science, mroe women than men pursue these degrees. One exception to this rule is biological sciences, in which more women than men pursue these degrees.

One concern with this dataset is that we can only see the number of degrees earned by women and men across years and fields. It does not give us any information, such as in-major GPAs, of how well women and men did in their degrees. Without this information, there is no way to measure how successful women and men are at completing their degrees, which could also impact their future career outcomes. Additionally, without career outcome information, we cannot conclusively state that science-related fields are male dominated in the workforce. Another concern is that this dataset only provides information up until 2016, which bars us from analyzing the gender difference in science-related fields in more recent years.

## Appendix

To help out, we have included some R-codes here as references. You should make your own chunks filled with texts going through each items listed above. Make sure to hide the unnecessary outputs/code etc. 

1. Clean data

```{r data wrangling, echo = FALSE, warning = FALSE}
# For the demonstration purpose, we show this R-chunk by taking echo=TRUE
# In your final report you should hide all the R-chunks to keep your report flowing well.
wsci <- read_excel("data/WomenData_06_16.xlsx")
names(wsci)
head(wsci)
#change names
wsci %<>% 
  rename(Field = 'Field and sex')
# set the field, degree and sex as factors
wsci %<>% 
  mutate( Field = as.factor(Field))
```


```{r, echo=FALSE}
wsci %<>%
  rename(
         Number = "Degrees Awarded") %>%
  mutate(
         Degree = as.factor(Degree),
         Sex = as.factor(Sex))

```


2. A number of sample analyses 

```{r eval = FALSE, echo = FALSE}
wsci %>%  # to get the average number of ppl by gender
  group_by(Field, Sex) %>%
  summarise(deg = mean(Number))

wsci %>%
  filter(Year == 2007) %>%
  ggplot(aes(x = Field, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Degree~., scales = "free_y") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  ggtitle("Degrees granted across fields by degree and gender") 

wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = SE, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.y = element_text(angle = 60)) +
  ggtitle("Degrees granted by S&E vs non-S&E by gender")

wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year) %>%
  summarise(SE_number = sum(Number)) %>%
  group_by(SE, Year) %>%
  mutate(ratio = SE_number / sum(SE_number)) %>%
  filter(Sex == "Female") %>%
  ggplot(aes(x = Year, y = ratio, color = SE)) +
  geom_point() + geom_line() +
  ggtitle("Female proportion in SE/non-SE across year")

wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  group_by(SE, Year, Degree) %>%
  mutate(ratio = SE_number / sum(SE_number)) %>%
  filter(Sex == "Female") %>%
  ggplot(aes(x = Year, y = ratio, color = SE)) +
  geom_point() + geom_line() +
  facet_grid(~Degree)+
  ggtitle("Female proportion in SE/non-SE across year by degree")


wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = Year, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(SE~Degree, scales = "free_y") +
  ggtitle("Degrees granted by sex, degree and SE")


wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = Year, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(SE~Degree, scales = "free_y") +
  ggtitle("Degrees granted proportion by sex across degree and SE")


wsci %>%
  filter(Field %in% c("Computer sciences", "Mathematics and statistics")) %>%
  ggplot(aes(x = Year, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Field~Degree, scales = "free_y") +
  ggtitle("Degrees granted pr option by sex across degree and SE")


wsci %>%
  ggplot(aes(x = Year, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Field~Degree, scales = "free_y") +
  ggtitle("Degrees granted proportion by sex across degree and SE")
```




# Case study 3: Major League Baseball

We would like to explore how payroll affects performance among Major League Baseball teams. The data is prepared in two formats record payroll, winning numbers/percentage by team from 1998 to 2014. 

Here are the datasets:

-`MLPayData_Total.csv`: wide format
-`baseball.csv`: long format

Feel free to use either dataset to address the problems. 

## EDA: Relationship between payroll changes and performance

Payroll may relate to performance among ML Baseball teams. One possible argument is that what affects this year's performance is not this year's payroll, but the amount that payroll increased from last year. Let us look into this through EDA. 

Create increment in payroll

a). To describe the increment of payroll in each year there are several possible approaches. Take 2013 as an example:

    - option 1: diff: payroll_2013 - payroll_2012
    - option 2: log diff: log(payroll_2013) - log(payroll_2012)

Explain why the log difference is more appropriate in this setup.

In this set up, the log difference is more appropriate because it allows us to get a better understanding of the percentage change of payroll between each year. Since players have different magnitudes in pay, taking the log allows us to base our analysis on the percentage change.

```{r, include=FALSE}
baseball = read.csv("./data/baseball.csv")
head(baseball)
```

b). Create a new variable `diff_log=log(payroll_2013) - log(payroll_2012)`. Hint: use `dplyr::lag()` function.
```{r}
diff_log = baseball %>% filter(year %in% c(2012, 2013)) %>% group_by(team) %>% mutate(logpay = log(payroll)) %>% mutate(diff_log = logpay - lag(logpay), order_by=year)
head(diff_log, 20)
```

c). Create a long data table including: team, year, diff_log, win_pct

```{r}
diff_log_df = baseball %>% group_by(team) %>% mutate(logpay = log(payroll)) %>% mutate(diff_log = logpay - lag(logpay), order_by=year) %>% select(team, year, diff_log, win_pct)
head(diff_log_df, 20)
```


## Exploratory questions

a). Which five teams had highest increase in their payroll between years 2010 and 2014, inclusive?

The LA Dogers, Washington Nationals, San Diego Padres, Texas Rangers, and San Francisco Giants had the highest increase in their payrolls.

```{r}
pay_raise = diff_log_df %>% filter(year %in% c(2010, 2011, 2012, 2013, 2014)) %>% group_by(team) %>% mutate(total_diff_log=sum(diff_log)) %>% select(team, total_diff_log) %>% distinct() %>% arrange(desc(total_diff_log))
head(pay_raise, 5)
```

b). Between 2010 and 2014, inclusive, which team(s) "improved" the most? That is, had the biggest percentage gain in wins?
The Pittsburgh Pirates improved the most.
```{r}
win_gains = diff_log_df %>% filter(year %in% c(2010, 2014)) %>% group_by(team) %>% mutate(win_gain=win_pct-lag(win_pct), order_by=year) %>% select(team, win_gain) %>% drop_na(win_gain) %>% arrange(desc(win_gain))
head(win_gains, 5)
```

## Do log increases in payroll imply better performance? 

Is there evidence to support the hypothesis that higher increases in payroll on the log scale lead to increased performance?

Pick up a few statistics, accompanied with some data visualization, to support your answer. 

## Comparison

Which set of factors are better explaining performance? Yearly payroll or yearly increase in payroll? What criterion is being used? 






